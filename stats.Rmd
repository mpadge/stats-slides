---
title: "rOpenSci Statistical<br>Software Review"
subtitle: "A Community Introduction to Standards and Package Development Tools"
author: "Mark Padgham & Noam Ross<br>June 18, 2021<br>MÃ¼nster, Germany & New York, USA"
output:
      xaringan::moon_reader:
            lib_dir: libs
            css: xaringan-themer.css
            self_contained: true
            mathjax: null
            nature:
                  highlightStyle: github
                  highlightLines: true
                  countIncrementalSlides: false
---

```{r xaringan, include = FALSE}
library(xaringanthemer)
source ("myxaringantheme.R")
```

```{r setup, include=FALSE}
options(htmltools.dir.version = FALSE)# suppress version num in subdir name

knitr::opts_chunk$set(cache = TRUE,
                      warning = FALSE)
                      #message = FALSE)
```
class: left, top
background-image: url(img/icon_lettering_color_large-faded.png)
background-size: contain
background-position: 50% 50%

# Agenda (starts 4PM GMT)

- Introduction (5 min)
- rOpenSci Peer Review + Statistical Standards - Noam Ross (15 min)
- Package Development tools: *srr*, **autotest**, and **pkgcheck**  - Mark Padgham (25 min)
- Q & A (15 min)

Collaborative note-taking (Please add your name, questions, notes): <https://bit.ly/ro-stats-tools>

Find all videos and resources from our Community Calls: <https://ropensci.org/commcalls/>

---
class: left, top
background-image: url(img/icon_lettering_color_large-faded.png)
background-size: contain
background-position: 50% 50%

# rOpenSci Software Peer Review

- A peer-review system integrating practices from software development and academic publishing
- Designed to improve software and expand a community of practices, via transparent, constructive, non-adversarial and open review"
- Has historically covered packages that support the data management life cycle
- 7 years experience, hundreds of packages, authors and reviewers

Example Review: <https://github.com/ropensci/software-review/issues/409>

---
class: left, top
background-image: url(img/icon_lettering_color_large-faded.png)
background-size: contain
background-position: 50% 50%

# rOpenSci & Software Peer Review: Why Participate?

- Feedback & improved software quality
- Support from rOpenSci
- Promotion of your software
- Cross-linking with other software
- Publications

Previously these benefits were unavailable for authors writing packages that
implemented statistical algorithms. 

---
class: left, top
background-image: url(img/icon_lettering_color_large-faded.png)
background-size: contain
background-position: 50% 50%

# Expanding Peer Review for Statistical Software

-  Many new challenges for statistical software
-  A community-driven process for what needed to be included in standards
-  Sub-standards for different statistical fields
-  A process for introducing new standards
   - Graded badging (standard, silver, gold)
   - Community events (like this)
   - Tools and documentation to support package authors

Standards and process all documented at: <https://stats-devguide.ropensci.org/>

---
class: left, top
background-image: url(img/icon_lettering_color_large-faded.png)
background-size: contain
background-position: 50% 50%

# Tools for Package Authors

- All tools can and should be used from the moment a package first takes form

- `srr` = "software review roclets" for documenting standards compliance
  within a package

- `autotest` for automated testing

- `pkgcheck` to confirm whether a (statistics or other) package is ready for
  submission


---
class: left, top
background-image: url(img/icon_lettering_color_large-faded.png)
background-size: contain
background-position: 50% 50%

# Software Review Roclets:<br>The 'srr' package

## Why?

- Standards hard to keep track of for both authors and reviewers

- `srr` lets you build standards tracking into your development process

- Enables complete documentation of standards compliance


---
class: left, top
background-image: url(img/icon_lettering_color_large-faded.png)
background-size: contain
background-position: 50% 50%

# Software Review Roclets:<br>The 'srr' package

## roxygen2

```{r roxygen-ex}
#' Function to add two numbers
#'
#' @rdtitle Addtwo
#' @param x First input
#' @param y Second input
#' @return Sum of x and y
#' @export
addtwo <- function (x, y) {
    return (x + y)
}
```

--

Run `roxygen2::roxygenise()` to turn<br>that into `/man` file `Addtwo.Rd`


---
class: left, top
background-image: url(img/icon_lettering_color_large-faded.png)
background-size: contain
background-position: 50% 50%

# Software Review Roclets:<br>The 'srr' package

- `roxygen2` is extensible, and allows custom "roclets"

- Everything following `@` is a "tag"

- Each "roclet" has a generic `process` method, and an `output` method to
  output information to the `.Rd` file

- Setting `output` method to `NULL` allows new tags with arbitrary `process`
  methods that do not appear in package documentation.

---
class: left, top
background-image: url(img/icon_lettering_color_large-faded.png)
background-size: contain
background-position: 50% 50%

# Software Review Roclets:<br>The 'srr' package

- `srr` introduces new tags for documenting standards:
    - `@srrstats` for adherence to standards
    - `@srrstatsNA` for non-applicable standards
    - `@srrstatsTODO` for standards yet to be addressed

- Running `roxygen2::roxygenise()` automatically generates a summary report of
  standards compliance on screen

---
class: left, top
background-image: url(img/icon_lettering_color_large-faded.png)
background-size: contain
background-position: 50% 50%

# Software Review Roclets:<br>The 'srr' package

```{r roxygen-ex-repeat}
#' Function to add two numbers
#'
#' @rdtitle Addtwo
#' @param x First input
#' @param y Second input
#' @return Sum of x and y
#' @export
addtwo <- function (x, y) {
    return (x + y)
}
```


---
class: left, top
background-image: url(img/icon_lettering_color_large-faded.png)
background-size: contain
background-position: 50% 50%

# Software Review Roclets:<br>The 'srr' package

```{r roxygen-ex-srr}
#' Function to add two numbers
#'
#' @rdtitle Addtwo
#' @param x First input
#' @param y Second input
#' @return Sum of x and y
#' @export
#'
#' @srrstats {G1.1} Primary citation for this function follows
#' @references Smith & Jones (2021) A new addition algorithm
addtwo <- function (x, y) {
    return (x + y)
}
```

---
class: left, top
background-image: url(img/icon_lettering_color_large-faded.png)
background-size: contain
background-position: 50% 50%

# Software Review Roclets:<br>The 'srr' package

```{r roxygenise-demo1, eval = FALSE}
roxygen2::roxygenise(path)
```

```{r roxygenise-demo1-output, echo = FALSE, message = TRUE, collapse = TRUE}
cli::cli_alert_info ("Loading demo")
cli::cli_h1 ("rOpenSci Statistical Software Standards")
cli::cli_h3 ("@srrstats standards:")
cli::cli_li ("[G1.1] in function 'addtwo()' on line#11 of file [R/test.R]")
```



---
class: left, top
background-image: url(img/icon_lettering_color_large-faded.png)
background-size: contain
background-position: 50% 50%

# The 'srr' package: How To

- The `srr_stats_roxygen()` function dumps full text of all standards in file
  `R/srr-stats-standards.R`

- All are initially tagged `@srrstatsTODO`

- Standards are addressed by changing tag to `@srrstats` and moving to location
  within code where standard is addressed

---
class: left, top
background-image: url(img/icon_lettering_color_large-faded.png)
background-size: contain
background-position: 50% 50%

# The 'srr' package: How To

In package directory:

```{r srr-stats-roxy, eval = FALSE}
srr_stats_roxygen (category = "ml")
```
```{r srr-stats-roxy-tmp, echo = FALSE, message = TRUE, collapse = TRUE}
library (srr)
d <- srr_stats_pkg_skeleton ()
z <- file.remove (file.path (d, "R", "srr-stats-standards.R"))
#withr::with_dir (d, srr_stats_roxygen (category = "ml"))
wd <- setwd (d)
srr_stats_roxygen (category = "ml")
setwd (wd)
```

---
class: left, top
background-image: url(img/icon_lettering_color_large-faded.png)
background-size: contain
background-position: 50% 50%

# The 'srr' package: How To

```{r filepath, echo = FALSE}
f <- file.path (d, "R", "srr-stats-standards.R")
s <- readLines (f)
```


```{r srr-stats-roxy-ex, echo = FALSE, message = TRUE, collapse = TRUE}
s [1:99]
```


---
class: left, top
background-image: url(img/icon_lettering_color_large-faded.png)
background-size: contain
background-position: 50% 50%

# The 'srr' package: How To


```{r srr-stats-roxy-ex-short, echo = FALSE, message = TRUE, collapse = TRUE}
s [1:14]
```

File has:

- `r length (s)` lines
- `r length(grep("^#' @srrstats", s))` standards

---
class: left, top
background-image: url(img/icon_lettering_color_large-faded.png)
background-size: contain
background-position: 50% 50%

# Software Review Roclets: The 'srr' package

- `srr_report()` function generates a `.html` report of standards compliance

- [Example](https://ropensci-review-tools.github.io/roreviewapi/static/demo_srr77dfe392.html)

--

- Also extensible, with alternative standards substituted by modifying a single
  URL

---
class: left, top
background-image: url(img/icon_lettering_color_large-faded.png)
background-size: contain
background-position: 50% 50%

# Tools for Package Authors

- All tools can and should be used from the moment a package first takes form

- `srr` = "software review roclets" for documenting standards compliance
  within a package

- .large[ `autotest` for automated testing ]

- `pkgcheck` to confirm whether a (statistics or other) package is ready for
  submission

---
class: left, top
background-image: url(img/icon_lettering_color_large-faded.png)
background-size: contain
background-position: 50% 50%

# The 'autotest' package

## Why?

- Make code more robust

- Find bugs before other users or reviewers find them

---
class: left, top
background-image: url(img/icon_lettering_color_large-faded.png)
background-size: contain
background-position: 50% 50%

# The 'autotest' package

## How?

- A form of "mutation testing"

- Identifies all inputs to all functions through extracting documented example
  code

- Mutates those inputs

- Also matches input and output types to descriptions

---
class: left, top
background-image: url(img/icon_lettering_color_large-faded.png)
background-size: contain
background-position: 50% 50%

# The 'autotest' package

```{r mkpkg, echo = FALSE, output = FALSE, message = FALSE}
rm (addtwo)
if (dir.exists (file.path (here::here (), "demo")))
    unlink (file.path (here::here (), "demo"),
            recursive = TRUE)
x <- capture.output (source ("mkpkg.R"))
path <- file.path (here::here (), "demo")
out <- capture.output (roxygen2::roxygenise (path))
```
```{r autotest1-fakey, eval = FALSE}
library (autotest)
autotest_package (path, test = TRUE)
```
```{r autotest1, eval = TRUE, echo = FALSE, collapse = TRUE}
library (autotest)
path <- file.path (here::here (), "demo")
a1 <- autotest_package (path, test = TRUE)
print (as.data.frame (a1))
```



---
class: left, top
background-image: url(img/icon_lettering_color_large-faded.png)
background-size: contain
background-position: 50% 50%

# The 'autotest' package

```{r add-ex-to-demo, echo = FALSE, message = FALSE, eval = FALSE}
path <- file.path (here::here (), "demo")
f <- file.path (path, "R", "test.R")
x <- readLines (f)
i <- max (grep ("^#' @", x))
x <- c (x [1:i],
        "#' @examples",
        "#' y <- addtwo (1, 2)",
        x [-seq (i)])
writeLines (x, f)
out <- capture.output (roxygen2::roxygenise (path))
```
```{r demo-ex, eval = FALSE}
#' @examples
#' addtwo (1, 2)
```
```{r autotest2-fakey, eval = FALSE}
autotest_package (path, test = TRUE)$content
```
```{r autotest2, eval = TRUE, echo = FALSE, collapse = TRUE}
x <- c ("[1] Parameter [x] is not specified as integer, yet only used as such;\n",
        "    please use '1L' for integer, or 1.0 for non-integer values.\n\n",
        "[2] Parameter [x] of function [addtwo] is assumed to be a single numeric,\n",
        "    but responds to vectors of length > 1\n\n",
        "[3] Parameter [y] is not specified as integer, yet only used as such;\n",
        "    please use '1L' for integer, or 1.0 for non-integer values.\n\n",
        "[4] Parameter [y] of function [addtwo] is assumed to be a single numeric,\n",
        "    but responds to vectors of length > 1")
message (x)
```

---
class: left, top
background-image: url(img/icon_lettering_color_large-faded.png)
background-size: contain
background-position: 50% 50%

# Tools for Package Authors

- All tools can and should be used from the moment a package first takes form

- `srr` = "software review roclets" for documenting standards compliance
  within a package

- `autotest` for automated testing

- .large[ `pkgcheck` to confirm whether a (statistics or other) package is ready for
  submission]


---
class: left, top
background-image: url(img/icon_lettering_color_large-faded.png)
background-size: contain
background-position: 50% 50%

# The 'pkgcheck' package

## Why?

- To confirm whether a package is ready for submission

- To provide a statistical overview of package structure relative to all other
  CRAN packages

- To generate useful information for package reviewers


---
class: left, top
background-image: url(img/icon_lettering_color_large-faded.png)
background-size: contain
background-position: 50% 50%

# The 'pkgcheck' package

```{r pkgcheck-run, eval = FALSE, echo = FALSE}
path <- file.path (here::here (), "demo")
library (pkgcheck)
chk <- pkgcheck (path)
saveRDS (chk, "pkgcheck-demo.Rds")
```
```{r pkgcheck1-fakey, eval = FALSE, echo = TRUE}
library (pkgcheck)
chk <- pkgcheck (path)
summary (chk)
```

```{r pkgcheck-out, echo = FALSE, collapse = TRUE}
library (pkgcheck)
chk <- readRDS ("pkgcheck-demo.Rds")
summary (chk)
```

---
class: left, top
background-image: url(img/icon_lettering_color_large-faded.png)
background-size: contain
background-position: 50% 50%

# The 'pkgcheck' package

```{r pkgcheck2-fakey, eval = FALSE, echo = TRUE}
library (pkgcheck)
chk <- pkgcheck (path)
# print (chk) # lots of output!
names (chk)
```

```{r pkgcheck2-out, echo = FALSE, collapse = TRUE}
library (pkgcheck)
chk <- readRDS ("pkgcheck-demo.Rds")
print (names (chk), width = 50)
```

[Example here](https://github.com/mpadge/srr-demo/issues/1#issuecomment-853048702)



---
class: left, top
background-image: url(img/icon_lettering_color_large-faded.png)
background-size: contain
background-position: 50% 50%

# Statistical Software Peer Review

- Now accepting submissions

- Use of `autotest` will enable reviews to better focus on substantive issues of software design and quality

- `srr` provides a comprehensive method for documenting standards
  compliance within code itself

- Associated `html` reports facilitate rapid review of standards compliance

- Result should be high quality statistical software with open and demonstrable compliance with standards
